<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot Vocab Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .option-button {
            transition: all 0.2s;
            cursor: pointer;
        }
        .option-button:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
        }
        /* Custom styles for disabled/answered states */
        .correct { background-color: #d1fae5; border-color: #10b981; }
        .incorrect { background-color: #fee2e2; border-color: #ef4444; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Revision Modal (Hidden by default) -->
    <div id="revision-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white card w-full max-w-xl max-h-[90vh] overflow-y-auto p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Revision List</h2>
            <div id="revision-content" class="space-y-4">
                <!-- Revision items will be injected here -->
            </div>
            <button class="mt-6 w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150" onclick="hideRevisionModal()">Close</button>
        </div>
    </div>
    
    <!-- Main Application Container -->
    <div id="app" class="w-full max-w-lg card p-6 md:p-8">
        
        <!-- Header with Revision Button -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">üß† Polyglot Quiz</h1>
            <button id="revision-button" class="hidden bg-gray-200 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 transition duration-150 shadow" onclick="showRevisionModal()">
                Revision List (0)
            </button>
        </div>

        <!-- Configuration Screen -->
        <div id="config-screen">
            <p class="text-gray-600 mb-6 text-center">Tell me what you'd like to test!</p>
            <form id="config-form" class="space-y-4">
                <div>
                    <label for="language" class="block text-sm font-medium text-gray-700 mb-1">Target Language:</label>
                    <select id="language" name="language" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" disabled selected>Select a language</option>
                        <option value="French">French</option>
                        <option value="Italian">Italian</option>
                        <option value="Spanish">Spanish</option>
                        <option value="Portuguese">Portuguese</option>
                        <option value="German">German</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Korean">Korean</option>
                        <option value="Mandarin Chinese">Mandarin Chinese</option>
                        <option value="Hebrew">Hebrew</option>
                    </select>
                </div>
                <div>
                    <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-1">Difficulty Level:</label>
                    <select id="difficulty" name="difficulty" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" disabled selected>Select difficulty</option>
                        <option value="Beginner (A1/A2)">Beginner (A1/A2)</option>
                        <option value="Intermediate (B1/B2)">Intermediate (B1/B2)</option>
                        <option value="Advanced (C1/C2)">Advanced (C1/C2)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Start Quiz</button>
            </form>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="hidden flex flex-col items-center justify-center py-12">
            <div class="loader mb-4"></div>
            <p class="text-gray-600 font-medium">Generating your vocabulary quiz...</p>
            <p class="text-sm text-gray-500 mt-2 text-center" id="loading-details"></p>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="mb-6">
                <p class="text-sm text-indigo-600 font-medium mb-1" id="quiz-progress"></p>
                <h2 class="text-xl font-semibold text-gray-800 mb-2" id="quiz-word"></h2>
                
                <!-- Example Sentence with Pronounce Button -->
                <div class="flex justify-between items-start mb-4 p-2 bg-indigo-50 rounded-lg border border-indigo-200">
                    <p class="text-gray-800 text-sm italic mr-3" id="example-sentence-text"></p>
                    <button id="pronounce-button" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold p-1 rounded-full bg-white shadow-md transition duration-150 flex-shrink-0">
                        <!-- Play Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <p class="text-gray-700 mb-4 font-semibold">Which English definition is correct?</p>
            </div>

            <div id="options-container" class="space-y-3">
                <!-- Options buttons will be injected here -->
            </div>

            <!-- Explanation and Second Example - HIDDEN until answer is selected -->
            <div id="explanation-container" class="hidden mt-6 border-t pt-4 border-gray-200">
                <h3 class="text-md font-semibold text-indigo-700 mb-3">üîç Detailed Insight</h3>
                
                <div class="space-y-3">
                    <!-- Main Example Translation -->
                    <div>
                        <p class="text-xs font-semibold text-gray-600">Translation:</p>
                        <p class="text-sm text-gray-800 italic" id="example-translation"></p>
                    </div>
                    
                    <!-- Grammar Point -->
                    <div>
                        <p class="text-xs font-semibold text-gray-600">Grammar Focus:</p>
                        <p class="text-sm text-gray-700" id="grammar-point"></p>
                    </div>
                    
                    <!-- Etymology -->
                    <div>
                        <p class="text-xs font-semibold text-gray-600">Etymology/Root:</p>
                        <p class="text-sm text-gray-700" id="word-etymology"></p>
                    </div>
                    
                    <!-- Second Example -->
                    <div>
                        <p class="text-xs font-semibold text-gray-600">Second Example:</p>
                        <p class="text-sm text-gray-700" id="second-example"></p>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <p id="feedback-message" class="font-medium h-6"></p>
                <button id="next-button" class="hidden w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150">Next Question</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden text-center">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4">Quiz Complete! üéâ</h2>
            <p class="text-xl font-extrabold text-gray-800 mb-2">Correct: <span id="final-correct-count">0</span> / 5</p>
            <p class="text-xl font-extrabold text-gray-800 mb-6">Incorrect: <span id="final-incorrect-count">0</span> / 5</p>
            <button id="restart-button" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Try a New Quiz</button>
        </div>

        <!-- Error Message Container -->
        <div id="error-message" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
            <p class="font-bold">Error:</p>
            <p id="error-text" class="text-sm"></p>
        </div>
    </div>

    <!-- Firebase SDK Imports (required for Canvas environment) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Core Application Logic ---

        // Firebase Global Variables (Mandatory for setup)
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app;

        const firebaseConfig = {
            apiKey: "AIzaSyA1BUle9PjisG3ff7rqchBnO6HmCEUZ_Ww",
            authDomain: "french-vocab-game.firebaseapp.com",
            projectId: "french-vocab-game",
            storageBucket: "french-vocab-game.appspot.com",
            messagingSenderId: "950338044495",
            appId: "1:950338044495:web:3e5d184f0edc254872603a",
            measurementId: "G-6ZN9NC4PXK"
            };
        const apiKey = "AIzaSyAGz4qACN2g43o9cLUczi9APoRCAegUtbM";

        const appId = firebaseConfig.projectId; 
        const initialAuthToken = null;   
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // Application State
        let state = {
            appState: 'config', // 'config', 'loading', 'quiz', 'results'
            language: '',
            difficulty: '',
            questions: [],
            currentQuestionIndex: 0,
            correctCount: 0, 
            incorrectCount: 0, 
            isAnswered: false,
            revisionList: [], 
        };
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;


        // Elements
        const screens = {
            config: document.getElementById('config-screen'),
            loading: document.getElementById('loading-screen'),
            quiz: document.getElementById('quiz-screen'),
            results: document.getElementById('results-screen'),
        };
        const configForm = document.getElementById('config-form');
        const loadingDetails = document.getElementById('loading-details');
        const quizWord = document.getElementById('quiz-word');
        const quizProgress = document.getElementById('quiz-progress');
        const exampleSentenceElement = document.getElementById('example-sentence-text');
        const pronounceButton = document.getElementById('pronounce-button');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextButton = document.getElementById('next-button');
        const restartButton = document.getElementById('restart-button');
        const errorMessageDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const revisionButton = document.getElementById('revision-button');
        const explanationContainer = document.getElementById('explanation-container'); 
        
        // New explanation elements
        const exampleTranslationElement = document.getElementById('example-translation');
        const grammarPointElement = document.getElementById('grammar-point');
        const wordEtymologyElement = document.getElementById('word-etymology');
        const secondExampleElement = document.getElementById('second-example');


        // --- UI Rendering & State Management ---

        function updateUI() {
            Object.keys(screens).forEach(key => {
                screens[key].classList.add('hidden');
            });
            screens[state.appState].classList.remove('hidden');

            if (state.appState === 'quiz' || state.appState === 'results') {
                revisionButton.textContent = `Revision List (${state.revisionList.length})`;
                revisionButton.classList.remove('hidden');
            } else {
                revisionButton.classList.add('hidden');
            }

            if (state.appState === 'quiz') {
                renderQuestion();
            } else if (state.appState === 'results') {
                document.getElementById('final-correct-count').textContent = state.correctCount;
                document.getElementById('final-incorrect-count').textContent = state.incorrectCount;
            }
        }

        function renderQuestion() {
            const q = state.questions[state.currentQuestionIndex];
            if (!q) {
                state.appState = 'results';
                updateUI();
                return;
            }

            quizProgress.textContent = `Question ${state.currentQuestionIndex + 1} of ${state.questions.length} | ${state.language} (${state.difficulty})`;
            quizWord.textContent = q.word;

            // Display main foreign content
            exampleSentenceElement.textContent = `Example sentence: "${q.exampleSentence}"`;
            
            // Populate all content fields
            wordEtymologyElement.textContent = q.etymology;
            secondExampleElement.textContent = q.secondExample;
            exampleTranslationElement.textContent = q.exampleTranslation; // NEW
            grammarPointElement.textContent = q.grammarPoint; // NEW
            
            // HIDE EXPLANATION CONTAINER for a fresh question
            explanationContainer.classList.add('hidden');

            // Wire up the Pronounce button
            pronounceButton.onclick = pronounceSentence;

            optionsContainer.innerHTML = '';
            feedbackMessage.textContent = '';
            nextButton.classList.add('hidden');
            state.isAnswered = false;

            q.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-button w-full text-left p-3 border-2 border-gray-200 rounded-lg text-gray-800 font-medium transition duration-150';
                btn.textContent = option;
                btn.setAttribute('data-index', index);
                btn.onclick = () => handleAnswer(option, btn);
                optionsContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedOption, clickedButton) {
            if (state.isAnswered) return;
            state.isAnswered = true;
            
            const q = state.questions[state.currentQuestionIndex];
            const isCorrect = selectedOption === q.correctDefinition;

            // Highlight all buttons and disable clicks
            Array.from(optionsContainer.children).forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent === q.correctDefinition) {
                    btn.classList.add('correct');
                } else if (btn.textContent === selectedOption) {
                    btn.classList.add('incorrect');
                }
            });
            
            // SHOW EXPLANATION CONTAINER
            explanationContainer.classList.remove('hidden');

            if (isCorrect) {
                state.correctCount++;
                feedbackMessage.textContent = 'Correct! Well done.';
                feedbackMessage.className = 'font-medium text-green-600 h-6';
            } else {
                state.incorrectCount++;
                // Add to revision list
                state.revisionList.push({
                    word: q.word,
                    sentence: q.exampleSentence,
                    correct: q.correctDefinition,
                    etymology: q.etymology
                });
                revisionButton.textContent = `Revision List (${state.revisionList.length})`;
                feedbackMessage.textContent = `Incorrect. The correct definition was: ${q.correctDefinition}`;
                feedbackMessage.className = 'font-medium text-red-600 h-6';
            }

            nextButton.classList.remove('hidden');
        }

        function goToNextQuestion() {
            state.currentQuestionIndex++;
            if (state.currentQuestionIndex < state.questions.length) {
                renderQuestion();
            } else {
                state.appState = 'results';
                updateUI();
            }
        }

        function restartQuiz() {
            state = {
                appState: 'config',
                language: '',
                difficulty: '',
                questions: [],
                currentQuestionIndex: 0,
                correctCount: 0,
                incorrectCount: 0,
                isAnswered: false,
                revisionList: [],
            };
            errorMessageDiv.classList.add('hidden');
            updateUI();
        }


        // --- Revision Modal Logic ---

        function showRevisionModal() {
            const modal = document.getElementById('revision-modal');
            const content = document.getElementById('revision-content');
            content.innerHTML = '';

            if (state.revisionList.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-4">You haven\'t missed any words yet! Keep going!</p>';
            } else {
                state.revisionList.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-4 bg-red-50 rounded-lg border border-red-200';
                    div.innerHTML = `
                        <p class="font-bold text-red-700">${index + 1}. ${item.word} (<span class="text-gray-700">${item.correct}</span>)</p>
                        <p class="text-xs italic text-gray-500 mt-1">Example: "${item.sentence}"</p>
                        <p class="text-xs text-gray-600 mt-2 border-t border-red-100 pt-2">${item.etymology}</p>
                    `;
                    content.appendChild(div);
                });
            }
            modal.classList.remove('hidden');
        }

        function hideRevisionModal() {
            document.getElementById('revision-modal').classList.add('hidden');
        }
        // Expose functions globally for HTML calls
        window.showRevisionModal = showRevisionModal;
        window.hideRevisionModal = hideRevisionModal;


        // --- TTS Helper Functions (for pronunciation) ---

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);

            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');

            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);

            // Data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function pronounceSentence() {
            const btn = document.getElementById('pronounce-button');
            const sentence = exampleSentenceElement.textContent.replace('Example sentence: "', '').replace('"', '');
            
            // Check if already disabled or no sentence
            if (btn.disabled || !sentence) return;

            btn.disabled = true;
            // Show spinning loader icon
            btn.innerHTML = `<div class="loader h-5 w-5 border-t-2 !border-indigo-600 !border-2"></div>`; 
            
            // Use a specific voice, for example 'Kore' as a neutral option
            const voiceName = "Kore"; 

            const payload = {
                contents: [{
                    parts: [{ text: sentence }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            try {
                const response = await fetch(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`TTS API failed with status ${response.status}`);

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => URL.revokeObjectURL(audioUrl); 
                    
                } else {
                    throw new Error("Invalid audio data received.");
                }

            } catch (e) {
                console.error("TTS Pronunciation Error:", e);
                feedbackMessage.textContent = 'Pronunciation failed. Check console for details.';
                feedbackMessage.className = 'font-medium text-red-600 h-6';
            } finally {
                 // Restore Play icon
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>`;
            }
        }
        // --- Gemini API Interaction (Quiz Content) ---

        const QUIZ_SCHEMA = {
            type: "ARRAY",
            description: "A list of exactly 5 vocabulary quiz questions.",
            items: {
                type: "OBJECT",
                properties: {
                    "word": { "type": "STRING", "description": "The foreign word being tested." },
                    "correctDefinition": { "type": "STRING", "description": "The single correct English definition." },
                    "options": {
                        "type": "ARRAY",
                        "description": "An array of exactly four definition strings, including the correct one.",
                        "items": { "type": "STRING" }
                    },
                    "exampleSentence": { "type": "STRING", "description": "A sentence in the foreign language using the word." },
                    "exampleTranslation": { "type": "STRING", "description": "The English translation of the exampleSentence." }, // NEW
                    "grammarPoint": { "type": "STRING", "description": "A brief explanation of a relevant grammar point based on the difficulty level (e.g., conjugation, adjective placement, case usage)." }, // NEW
                    "etymology": { "type": "STRING", "description": "A brief explanation of the word's origin, root, and related concepts." },
                    "secondExample": { "type": "STRING", "description": "Another short sentence in the foreign language with its English translation included, e.g., 'Sentence (English Translation)'" }
                },
                "propertyOrdering": ["word", "correctDefinition", "options", "exampleSentence", "exampleTranslation", "grammarPoint", "etymology", "secondExample"]
            }
        };

        async function fetchQuizContent(language, difficulty) {
            loadingDetails.textContent = `Asking the model to generate ${language} words at a ${difficulty} level...`;
            const systemPrompt = "You are an expert language tutor. Your task is to create a multiple-choice vocabulary quiz based on the user's request. The quiz must contain exactly 5 questions. The response MUST be a valid JSON array of question objects, adhering strictly to the provided JSON schema. Ensure all options are distinct and plausible, and the correct definition is included in the options list.";
            const userQuery = `Generate a vocabulary quiz for the "${language}" language at the "${difficulty}" difficulty level. For each word, include four English definitions, an example sentence, its English translation, a short etymology, a second example sentence with its English translation, and a brief, relevant grammar point for a ${difficulty} student.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: QUIZ_SCHEMA
                }
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        throw new Error("API response was missing expected content.");
                    }

                    const questions = JSON.parse(jsonText);

                    if (!Array.isArray(questions) || questions.length !== 5 || !questions.every(q => q.word && q.options && q.options.length === 4)) {
                        throw new Error("Generated JSON structure is invalid or incomplete. Retrying...");
                    }

                    return questions;

                } catch (e) {
                    console.error(`Attempt ${attempt + 1} failed:`, e);
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`Failed to generate quiz after ${maxRetries} attempts. Details: ${e.message}`);
                    }
                }
            }
        }

        // --- Event Handlers ---

        configForm.onsubmit = async (e) => {
            e.preventDefault();
            errorMessageDiv.classList.add('hidden');
            const formData = new FormData(configForm);
            state.language = formData.get('language');
            state.difficulty = formData.get('difficulty');
            
            state.appState = 'loading';
            updateUI();

            try {
                const questions = await fetchQuizContent(state.language, state.difficulty);
                state.questions = questions;
                state.currentQuestionIndex = 0;
                state.correctCount = 0;
                state.incorrectCount = 0;
                state.revisionList = [];
                state.appState = 'quiz';
            } catch (error) {
                console.error("Quiz Generation Failed:", error);
                errorText.textContent = error.message;
                errorMessageDiv.classList.remove('hidden');
                state.appState = 'config'; // Go back to config on failure
            }

            updateUI();
        };

        nextButton.onclick = goToNextQuestion;
        restartButton.onclick = restartQuiz;

        // --- Initialization ---

        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            // Initial anonymous or token sign-in
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Token sign-in failed:", e));
                            } else {
                                await signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                            }
                        }
                        isAuthReady = true;
                        if (!userId && auth.currentUser) {
                            userId = auth.currentUser.uid;
                        } else if (!userId) {
                             // Fallback if sign-in fails or is pending, use random ID
                            userId = crypto.randomUUID();
                        }
                        console.log(`Firebase Ready. App ID: ${appId}, User ID: ${userId}`);
                    });
                } else {
                    console.warn("Firebase config is empty. Running without authentication/persistence features.");
                    userId = crypto.randomUUID();
                    isAuthReady = true;
                }
            } catch (e) {
                console.error("Firebase setup failed:", e);
                userId = crypto.randomUUID();
                isAuthReady = true;
            }
        }

        window.onload = () => {
            setupFirebase();
            updateUI();
        };

    </script>
</body>
</html>
